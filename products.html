<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tienda de Productos</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      /* Estilos generales */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }

      header {
        background-color: #333;
        color: white;
        padding: 10px 20px;
      }

      main {
        padding: 20px;
        max-width: 1200px;
        margin: auto;
      }

      h1 {
        margin: 0;
      }

      /* Estilos de la sección productos */
      #productos {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .producto {
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        text-align: center;
      }

      img {
        width: 100%;
        height: auto;
        border-radius: 5px;
      }

      /* Estilos de los botones */
      button {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: auto;
        width: 50%; /* Reducir el ancho del botón */
        text-align: center; /* Alinear el texto del botón al centro */
      }

      button:hover {
        background-color: #0f6622;
      }

      /* Botones adicionales */
      #btn_verCarrito {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        display: block;
        margin: 20px auto;
        font-size: 16px;
      }

      #btn_add_newProduct {
        background-color: #ff6347;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        display: block;
        margin: 20px auto;
        font-size: 16px;
      }

      #btn_add_newProduct:hover {
        background-color: #ff4500;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Tienda de Productos</h1>
    </header>

    <main>
      <section id="productos">
        <!-- Los productos se cargarán aquí dinámicamente -->
      </section>

      <button id="btn_verCarrito">Ver carrito</button>
      <button id="btn_add_newProduct">Agregar nuevo producto</button>
    </main>

    <script>
        //Cada que se cargue la página, hacer que el botón se veo o no se vea dependiendo de si es profe o alumno.
        document.addEventListener("DOMContentLoaded", ajustar_Visibilidad);
        
        //FUNCION PARA SABER SI ES PROFE O ALUMNO
        function ajustar_Visibilidad() {
            const info = sessionStorage.getItem("info");

            // json fake para probar
            // let info = {
            //     user_type: "alumno"
            // };
            
            if (info) {
                // const info = JSON.parse(info);

                //Extarer tipo de usuario
                const userType = info.user_type;

                const botonAgregar = document.getElementById("btn_add_newProduct");

                if (userType === "profesor") {
                    botonAgregar.style.display = "block";
                } else if (userType === "alumno") {
                    botonAgregar.style.display = "none";
                }
            } else {
                //Error inesperado. Devolver al usuario al index para que obtenga su sessionStorage.
                console.error('Algo está mal');
                window.location.href = "/index.html";
            }
        }
        
      let api_url = "https://sw-seguro-back-productos.onrender.com";
      let token = null;

      let productos_procedentes = null;

      let productoDiv = document.getElementById("productos");

      function obtenerProductos() {
        return axios.get(`${api_url}/products`, {
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,
          },
          withCredentials: true,
        });
      }
      // Establece los productos predeterminados en localStorage si no existen
      function establecerProductosPorDefecto(productos) {
        // const productosPorDefecto = [{
        //     "id": '0482ce95-fb75-11ee-9009-127b183de277',
        //     "name": "play 5",
        //     "price": 8000,
        //     "img_url": "https://www.cnet.com/a/img/resize/673c0859dd0d8520d26e7515306c397b7e2beff6/hub/2016/06/14/a3d57ede-410b-4681-8fd9-1a9638e6385e/xbox-one-s.jpg?auto=webp&width=1200",
        //     "stock": 10
        // }];

        if (!localStorage.getItem("productos")) {
          localStorage.setItem("productos", JSON.stringify(productos));
        }
      }

      // Función para enviar productos a la base de datos
      // async function enviarProductosABaseDeDatos(productos) {
      //     const apiUrl = 'URL_DE_ESTEBAN';

      //     try {
      //         const response = await fetch(apiUrl, {
      //             method: 'POST',
      //             headers: {
      //                 'Content-Type': 'application/json'
      //             },
      //             body: JSON.stringify(productos)
      //         });

      //         if (response.ok) {
      //             console.log('Productos enviados a la base de datos con éxito.');
      //         } else {
      //             console.error('Error al enviar los productos a la base de datos:', response.statusText);
      //         }
      //     } catch (error) {
      //         console.error('Error de red:', error);
      //     }
      // }

      // Cargar productos desde localStorage
      function cargarProductos(productos) {
        const productosContainer = document.getElementById("productos");

        // Limpiar la sección de productos
        productosContainer.innerHTML = "";

        // Agregar cada producto a la sección de productos
        productos.forEach((producto) => {
          // const productoDiv = document.createElement('div');
          productoDiv.innerHTML += `<div>
                    <img src="${producto.img_url}"/>
                    <h2>${producto.name}</h2>
                    <h4>Stock: ${producto.stock}</h4>
                    <h4>Precio: $${producto.price}MXN</h4>
                    <button class="agregar-carrito" data-producto='${JSON.stringify(producto)}'>
                        Añadir ${producto.name} al carrito
                    </button>
                    </div>`;
          productoDiv.className = "producto";

          document.querySelectorAll('.agregar-carrito').forEach(boton=>{
            boton.addEventListener('click', function(){
              const productoJSON = this.getAttribute('data-producto');
              const producto = JSON.parse(productoJSON);
              // Aquí puedes utilizar el objeto producto normalmente
              agregarAlCarrito(producto)
            })
          })
        });
      }

      // Agregar producto al carrito
      function agregarAlCarrito(producto) {
        const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        carrito.push(producto);
        localStorage.setItem("carrito", JSON.stringify(carrito));
        console.log(`${producto.name} agregado al carrito`);
      }

      // Inicialización
      window.addEventListener("DOMContentLoaded", async () => {
        try {
          let productos = await obtenerProductos();
          console.log(productos.data.data);
          cargarProductos(productos.data.data);
        } catch (error) {
          console.log(error);
        }
      });

      // Botón para ver el carrito
      document
        .getElementById("btn_verCarrito")
        .addEventListener("click", () => {
          window.location.href = "BigCart.html";
        });

      // Botón para redirigir a la página de agregar productos
      document
        .getElementById("btn_add_newProduct")
        .addEventListener("click", () => {
          window.location.href = "add_product.html";
        });
    </script>
  </body>
</html>
